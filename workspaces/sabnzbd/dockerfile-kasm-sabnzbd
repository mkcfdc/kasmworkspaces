ARG BASE_TAG="1.18.0-rolling-daily"
ARG BASE_IMAGE="core-ubuntu-jammy"
FROM kasmweb/$BASE_IMAGE:$BASE_TAG

USER root

ENV HOME=/home/kasm-default-profile
ENV STARTUPDIR=/dockerstartup
ENV INST_SCRIPTS=$STARTUPDIR/install
WORKDIR $HOME

######### Install SABnzbd ###########

# Copy only installer scripts (not the config)
RUN mkdir -p $INST_SCRIPTS/sabnzbd
COPY ./install_sabnzbd.sh $INST_SCRIPTS/sabnzbd/install_sabnzbd.sh
RUN chmod +x $INST_SCRIPTS/sabnzbd/install_sabnzbd.sh

# Copy config file somewhere permanent BEFORE installer dir is deleted
COPY ./sabnzbd.ini $STARTUPDIR/sabnzbd.ini

# Run installer and then delete builder directory
RUN bash $INST_SCRIPTS/sabnzbd/install_sabnzbd.sh && \
    rm -rf $INST_SCRIPTS/sabnzbd/

######### Install custom startup script ###########

COPY ./custom_startup.sh $STARTUPDIR/custom_startup.sh
RUN chmod 755 $STARTUPDIR/custom_startup.sh

######### Single-Application Environment Tweaks ###########

RUN cp $HOME/.config/xfce4/xfconf/single-application-xfce-perchannel-xml/* \
       $HOME/.config/xfce4/xfconf/xfce-perchannel-xml/

RUN cp /usr/share/backgrounds/bg_kasm.png /usr/share/backgrounds/bg_default.png
RUN apt-get remove -y xfce4-panel

######### Switch to final user context ###########

RUN chown -R 1000:0 $HOME

ENV HOME=/home/kasm-user
WORKDIR $HOME

RUN mkdir -p $HOME && \
    mkdir -p $HOME/.sabnzbd && \
    cp $STARTUPDIR/sabnzbd.ini $HOME/.sabnzbd/sabnzbd.ini && \
    chown -R 1000:0 $HOME

USER 1000