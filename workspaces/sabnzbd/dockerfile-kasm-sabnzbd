ARG BASE_TAG="1.16.0"
ARG BASE_IMAGE="core-ubuntu-jammy"
FROM kasmweb/$BASE_IMAGE:$BASE_TAG

USER root

# 1. Set Environment correctly to prevent python encoding crashes
ENV HOME=/home/kasm-default-profile \
    STARTUPDIR=/dockerstartup \
    INST_SCRIPTS=/dockerstartup/install \
    DEBIAN_FRONTEND=noninteractive \
    LC_ALL=C.UTF-8 \
    LANG=C.UTF-8

WORKDIR $HOME

### 1. Install Basics & Tools required for PPAs
# Added 'gnupg' and 'dirmngr' which are strictly required for add-apt-repository to fetch keys
RUN apt-get update && \
    apt-get install -y \
        software-properties-common \
        curl \
        wget \
        gpg \
        gnupg \
        dirmngr \
        p7zip-full \
        unrar \
        par2 \
        python3-pip \
        xfce4-genmon-plugin \
    && rm -rf /var/lib/apt/lists/*

### 2. Install Sabnzbd
# We split these into separate RUN commands. 
# This prevents one massive chain from failing ambiguously and ensures state is saved between steps.
RUN add-apt-repository -y multiverse
RUN add-apt-repository -y universe
RUN add-apt-repository -y ppa:jcfp/nobetas
RUN add-apt-repository -y ppa:jcfp/sab-addons

# Now install the app
RUN apt-get update && \
    apt-get install -y sabnzbdplus python3-sabyenc par2-tbb && \
    rm -rf /var/lib/apt/lists/*

### 3. Install Brave Browser
RUN curl -fsSLo /usr/share/keyrings/brave-browser-archive-keyring.gpg https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main"|tee /etc/apt/sources.list.d/brave-browser-release.list && \
    apt-get update && \
    apt-get install -y brave-browser && \
    rm -rf /var/lib/apt/lists/*

### 4. Configure "Single Application" Mode
RUN apt-get remove -y xfce4-panel && \
    cp /usr/share/backgrounds/bg_kasm.png /usr/share/backgrounds/bg_default.png

### 5. Create the Custom Startup Script
RUN echo "#!/bin/bash" > $STARTUPDIR/custom_startup.sh && \
    echo "set -e" >> $STARTUPDIR/custom_startup.sh && \
    echo "mkdir -p \$HOME/.config/sabnzbd" >> $STARTUPDIR/custom_startup.sh && \
    echo "" >> $STARTUPDIR/custom_startup.sh && \
    echo "# 1. Start Sabnzbd in the background" >> $STARTUPDIR/custom_startup.sh && \
    echo "/usr/bin/sabnzbdplus --daemon --browser 0 --server 127.0.0.1:8080 --config-file \$HOME/.config/sabnzbd &" >> $STARTUPDIR/custom_startup.sh && \
    echo "" >> $STARTUPDIR/custom_startup.sh && \
    echo "# 2. Wait for Sabnzbd to initialize" >> $STARTUPDIR/custom_startup.sh && \
    echo "sleep 5" >> $STARTUPDIR/custom_startup.sh && \
    echo "" >> $STARTUPDIR/custom_startup.sh && \
    echo "# 3. Launch Brave in Kiosk/App mode pointing to Sabnzbd" >> $STARTUPDIR/custom_startup.sh && \
    echo "/usr/bin/brave-browser --no-sandbox --start-maximized --disable-gpu --app=http://127.0.0.1:8080" >> $STARTUPDIR/custom_startup.sh && \
    chmod +x $STARTUPDIR/custom_startup.sh

### 6. Permissions and User Cleanup
RUN chown 1000:0 $HOME
RUN $STARTUPDIR/set_user_permission.sh $HOME

ENV HOME=/home/kasm-user
WORKDIR $HOME
RUN mkdir -p $HOME && chown -R 1000:0 $HOME

USER 1000
