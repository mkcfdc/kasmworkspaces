ARG BASE_TAG="1.16.0"
ARG BASE_IMAGE="core-ubuntu-jammy"
FROM kasmweb/$BASE_IMAGE:$BASE_TAG

USER root

# 1. Set Environment
ENV HOME=/home/kasm-default-profile \
    STARTUPDIR=/dockerstartup \
    INST_SCRIPTS=/dockerstartup/install \
    DEBIAN_FRONTEND=noninteractive \
    LC_ALL=C.UTF-8 \
    LANG=C.UTF-8

WORKDIR $HOME

### 1. Install Dependencies & Tools
# Added 'jq' to the list so we can read the Kasm Launch Config JSON
RUN apt-get update && \
    apt-get install -y \
        curl \
        wget \
        gnupg \
        dirmngr \
        software-properties-common \
        apt-transport-https \
        p7zip-full \
        unrar \
        par2 \
        python3-pip \
        xfce4-genmon-plugin \
        jq \
    && rm -rf /var/lib/apt/lists/*

### 2. Install Sabnzbd (Manual Method)
# A. Enable Standard Repos
RUN add-apt-repository -y multiverse && add-apt-repository -y universe

# B. Import the JCFP PPA Key manually
RUN mkdir -p /etc/apt/keyrings && \
    curl -fsSL "https://keyserver.ubuntu.com/pks/lookup?op=get&options=mr&search=0xF13930B14BB9F05F" | gpg --dearmor -o /etc/apt/keyrings/jcfp-sabnzbd.gpg

# C. Add the Repository File
RUN echo "deb [signed-by=/etc/apt/keyrings/jcfp-sabnzbd.gpg] https://ppa.launchpadcontent.net/jcfp/nobetas/ubuntu jammy main" > /etc/apt/sources.list.d/jcfp-sabnzbd.list && \
    echo "deb [signed-by=/etc/apt/keyrings/jcfp-sabnzbd.gpg] https://ppa.launchpadcontent.net/jcfp/sab-addons/ubuntu jammy main" >> /etc/apt/sources.list.d/jcfp-sabnzbd.list

# D. Install Sabnzbd
RUN apt-get update && \
    apt-get install -y sabnzbdplus python3-sabyenc && \
    rm -rf /var/lib/apt/lists/*

### 3. Install Brave Browser
RUN curl -fsSLo /usr/share/keyrings/brave-browser-archive-keyring.gpg https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main"|tee /etc/apt/sources.list.d/brave-browser-release.list && \
    apt-get update && \
    apt-get install -y brave-browser && \
    rm -rf /var/lib/apt/lists/*

### 4. Configure Single App Mode
RUN apt-get remove -y xfce4-panel && \
    cp /usr/share/backgrounds/bg_kasm.png /usr/share/backgrounds/bg_default.png

### 5. Setup Custom Configuration & Startup
# Copy the Sabnzbd Template (Must exist in your local folder)
COPY sabnzbd.ini /etc/sabnzbd_template.ini

# Copy the Startup Script (Must exist in your local folder)
COPY custom_startup.sh $STARTUPDIR/custom_startup.sh
RUN chmod +x $STARTUPDIR/custom_startup.sh

### 6. Final Permissions
RUN chown 1000:0 $HOME
RUN $STARTUPDIR/set_user_permission.sh $HOME

ENV HOME=/home/kasm-user
WORKDIR $HOME
RUN mkdir -p $HOME && chown -R 1000:0 $HOME

USER 1000